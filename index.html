<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SizeKit - Manual Calibration</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Camera Screen -->
    <div id="camera-screen">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay-canvas"></canvas>
    </div>

    <!-- Instructions Overlay -->
    <div id="instructions">
        <div id="instruction-text">Tap the 4 corners of your credit card</div>
        <div id="instruction-detail">Start with TOP-LEFT corner</div>
        <button id="reset-btn" style="display: none;">Reset Corners</button>
    </div>

    <!-- Debug Console (bottom) -->
    <div id="debug-console">
        <div class="debug-line">Initializing...</div>
    </div>

    <!-- Load modules -->
    <script src="modules/camera.js"></script>
    <script src="modules/cardDetector.js"></script>

    <!-- Main app logic -->
    <script>
        // Credit card standard dimensions (ISO/IEC 7810 ID-1)
        const CARD_WIDTH_MM = 85.6;
        const CARD_HEIGHT_MM = 53.98;

        let debugLines = [];
        const maxDebugLines = 6;
        let tappedCorners = [];  // Initial user taps (hint for detection)
        let isInitialized = false;
        let pixelsPerMM = null;
        let cardDetector = null;
        let autoDetectionActive = false;

        const cornerNames = ['TOP-LEFT', 'TOP-RIGHT', 'BOTTOM-RIGHT', 'BOTTOM-LEFT'];

        /**
         * Add debug message to console
         */
        function addDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLines.push({ time: timestamp, msg: message, type: type });
            
            if (debugLines.length > maxDebugLines) {
                debugLines.shift();
            }
            
            const consoleEl = document.getElementById('debug-console');
            consoleEl.innerHTML = debugLines.map(line => {
                const className = line.type === 'error' ? 'debug-error' : 
                                 line.type === 'success' ? 'debug-success' :
                                 line.type === 'warning' ? 'debug-warning' : '';
                return `<div class="debug-line ${className}">[${line.time}] ${line.msg}</div>`;
            }).join('');
        }

        /**
         * Update instruction text
         */
        function updateInstructions() {
            const textEl = document.getElementById('instruction-text');
            const detailEl = document.getElementById('instruction-detail');
            const resetBtn = document.getElementById('reset-btn');

            if (tappedCorners.length < 4) {
                textEl.textContent = `Tap corner ${tappedCorners.length + 1} of 4`;
                detailEl.textContent = cornerNames[tappedCorners.length];
                resetBtn.style.display = tappedCorners.length > 0 ? 'block' : 'none';
            } else if (!autoDetectionActive) {
                textEl.textContent = 'Finding card edges...';
                detailEl.textContent = 'Please wait';
                resetBtn.style.display = 'block';
            } else {
                textEl.textContent = '✓ Card Locked!';
                detailEl.textContent = `Scale: ${pixelsPerMM ? pixelsPerMM.toFixed(2) + ' px/mm' : 'calculating...'}`;
                resetBtn.style.display = 'block';
            }
        }

        /**
         * Reset calibration
         */
        function resetDetection() {
            tappedCorners = [];
            isInitialized = false;
            pixelsPerMM = null;
            autoDetectionActive = false;
            if (cardDetector) {
                cardDetector.lastDetection = null;
                cardDetector.smoothedCorners = null;
            }
            updateInstructions();
            addDebug('Detection reset', 'warning');
        }

        /**
         * Get bounding box from 4 corners
         */
        function getBoundingBox(corners) {
            const xs = corners.map(c => c.x);
            const ys = corners.map(c => c.y);
            const minX = Math.min(...xs);
            const maxX = Math.max(...xs);
            const minY = Math.min(...ys);
            const maxY = Math.max(...ys);
            
            // Add 10% padding to search region
            const padding = 0.1;
            const width = maxX - minX;
            const height = maxY - minY;
            
            return {
                x: Math.max(0, minX - width * padding),
                y: Math.max(0, minY - height * padding),
                width: width * (1 + 2 * padding),
                height: height * (1 + 2 * padding)
            };
        }

        /**
         * Handle tap/click on canvas
         */
        function handleTap(event) {
            if (tappedCorners.length >= 4) return; // Already have hints

            const canvas = document.getElementById('overlay-canvas');
            const rect = canvas.getBoundingClientRect();
            
            // Get tap position in canvas coordinates
            let clientX, clientY;
            if (event.type === 'touchstart' || event.type === 'touchend') {
                clientX = event.touches[0]?.clientX || event.changedTouches[0]?.clientX;
                clientY = event.touches[0]?.clientY || event.changedTouches[0]?.clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }

            // Convert from screen coordinates to canvas coordinates
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;

            tappedCorners.push({ x, y });
            addDebug(`Hint ${tappedCorners.length}: (${x.toFixed(0)}, ${y.toFixed(0)})`, 'success');

            // If we have all 4 corners, start automatic detection
            if (tappedCorners.length === 4) {
                addDebug('Starting automatic detection...', 'info');
                isInitialized = true;
            }

            updateInstructions();
        }

        /**
         * Calculate pixels per millimeter from detected corners
         */
        function calculateScale(corners) {
            if (!corners || corners.length !== 4) return;
            
            // Calculate average width (top edge + bottom edge)
            const topWidth = Math.sqrt(
                Math.pow(corners[1].x - corners[0].x, 2) + 
                Math.pow(corners[1].y - corners[0].y, 2)
            );
            const bottomWidth = Math.sqrt(
                Math.pow(corners[2].x - corners[3].x, 2) + 
                Math.pow(corners[2].y - corners[3].y, 2)
            );
            const avgWidthPx = (topWidth + bottomWidth) / 2;

            // Calculate average height (left edge + right edge)
            const leftHeight = Math.sqrt(
                Math.pow(corners[3].x - corners[0].x, 2) + 
                Math.pow(corners[3].y - corners[0].y, 2)
            );
            const rightHeight = Math.sqrt(
                Math.pow(corners[2].x - corners[1].x, 2) + 
                Math.pow(corners[2].y - corners[1].y, 2)
            );
            const avgHeightPx = (leftHeight + rightHeight) / 2;

            // Calculate scale from both dimensions (average them)
            const scaleFromWidth = avgWidthPx / CARD_WIDTH_MM;
            const scaleFromHeight = avgHeightPx / CARD_HEIGHT_MM;
            const newScale = (scaleFromWidth + scaleFromHeight) / 2;
            
            // Only update if scale changed significantly (avoid spam)
            if (!pixelsPerMM || Math.abs(newScale - pixelsPerMM) / pixelsPerMM > 0.05) {
                pixelsPerMM = newScale;
                addDebug(`✓ Scale: ${pixelsPerMM.toFixed(2)} px/mm`, 'success');
            }
        }

        /**
         * Draw overlay (tapped hints or detected card)
         */
        function drawOverlay(ctx) {
            // Clear canvas
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            // Draw video frame
            const video = document.getElementById('video');
            ctx.drawImage(video, 0, 0, ctx.canvas.width, ctx.canvas.height);

            // If we have automatic detection active, use that
            if (autoDetectionActive && cardDetector.lastDetection) {
                // Draw the automatically detected card overlay
                cardDetector.drawOverlay(ctx, cardDetector.lastDetection);
            }
            
            // If still collecting taps, show tap hints (small dots)
            if (tappedCorners.length > 0 && tappedCorners.length < 4) {
                tappedCorners.forEach((corner, index) => {
                    // Draw small dot
                    ctx.beginPath();
                    ctx.arc(corner.x, corner.y, 8, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.8)';  // Yellow for hints
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Draw number
                    ctx.fillStyle = 'black';
                    ctx.font = 'bold 12px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText((index + 1).toString(), corner.x, corner.y);
                });
            }
            
            // If we just got all 4 taps but detection not active yet, show all taps
            if (tappedCorners.length === 4 && !autoDetectionActive) {
                tappedCorners.forEach((corner, index) => {
                    ctx.beginPath();
                    ctx.arc(corner.x, corner.y, 8, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.6)';
                    ctx.fill();
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                });
            }
        }

        /**
         * Initialize and run app
         */
        async function init() {
            try {
                addDebug('Starting camera...', 'info');
                
                const camera = new Camera();
                cardDetector = new CardDetector();
                
                const video = document.getElementById('video');
                const canvas = document.getElementById('overlay-canvas');
                const ctx = canvas.getContext('2d', {
                    willReadFrequently: true
                });

                // Initialize camera
                await camera.initialize(video, canvas);
                addDebug('✓ Camera ready', 'success');
                addDebug('Tap 4 corners of credit card', 'info');

                // Enable canvas interactions
                canvas.style.pointerEvents = 'auto';

                // Listen for taps (touch and click)
                canvas.addEventListener('click', handleTap);
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleTap(e);
                });

                // Reset button
                document.getElementById('reset-btn').addEventListener('click', resetDetection);

                // Main processing loop
                const processFrame = () => {
                    // If we have 4 taps and automatic detection not yet active
                    if (isInitialized && tappedCorners.length === 4 && !autoDetectionActive) {
                        // Get the region of interest from tapped corners
                        const searchRegion = getBoundingBox(tappedCorners);
                        
                        // Get image data
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // Try to detect card in that region
                        const detection = cardDetector.detectCard(imageData, searchRegion);
                        
                        if (detection && cardDetector.isStable()) {
                            // Success! Switch to automatic tracking
                            autoDetectionActive = true;
                            addDebug('✓ Card detected automatically!', 'success');
                            updateInstructions();
                        }
                    }
                    
                    // If automatic detection is active, keep detecting/tracking
                    if (autoDetectionActive && tappedCorners.length === 4) {
                        const searchRegion = getBoundingBox(tappedCorners);
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        const detection = cardDetector.detectCard(imageData, searchRegion);
                        
                        if (detection && detection.corners) {
                            // Calculate scale from detected corners
                            calculateScale(detection.corners);
                            updateInstructions();
                        }
                    }
                    
                    // Draw overlay
                    drawOverlay(ctx);
                    
                    requestAnimationFrame(processFrame);
                };
                
                processFrame();

            } catch (error) {
                console.error('Initialization error:', error);
                addDebug(`ERROR: ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError' || error.message.includes('permission')) {
                    addDebug('Camera access denied', 'error');
                } else if (!window.isSecureContext) {
                    addDebug('Requires HTTPS', 'error');
                }
            }
        }

        // Start app when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
