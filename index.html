<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SizeKit - Card Detection</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Camera Screen -->
    <div id="camera-screen">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay-canvas"></canvas>
    </div>

    <!-- Guide Rectangle -->
    <div id="guide-rectangle">
        <div id="guide-text">Position card here</div>
    </div>

    <!-- Debug Console (bottom) -->
    <div id="debug-console">
        <div class="debug-line">Initializing...</div>
    </div>

    <!-- Debug Toggle (top right) -->
    <button id="debug-toggle" style="position: fixed; top: 10px; right: 10px; z-index: 1001; background: rgba(0,0,0,0.7); color: #0f0; border: 1px solid #0f0; padding: 8px 12px; border-radius: 5px; font-size: 12px;">
        DEBUG: OFF
    </button>

    <!-- Load modules -->
    <script src="modules/camera.js"></script>
    <script src="modules/cardDetector.js"></script>

    <!-- Main app logic -->
    <script>
        let debugLines = [];
        const maxDebugLines = 8;
        let debugMode = false;

        /**
         * Add debug message to console
         */
        function addDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLines.push({ time: timestamp, msg: message, type: type });
            
            // Keep only recent lines
            if (debugLines.length > maxDebugLines) {
                debugLines.shift();
            }
            
            // Update display
            const consoleEl = document.getElementById('debug-console');
            consoleEl.innerHTML = debugLines.map(line => {
                const className = line.type === 'error' ? 'debug-error' : 
                                 line.type === 'success' ? 'debug-success' :
                                 line.type === 'warning' ? 'debug-warning' : '';
                return `<div class="debug-line ${className}">[${line.time}] ${line.msg}</div>`;
            }).join('');
        }

        /**
         * Initialize and run app
         */
        async function init() {
            try {
                addDebug('Starting camera initialization...', 'info');
                
                const camera = new Camera();
                const cardDetector = new CardDetector();
                
                const video = document.getElementById('video');
                const canvas = document.getElementById('overlay-canvas');
                const guideEl = document.getElementById('guide-rectangle');
                const debugToggle = document.getElementById('debug-toggle');
                const ctx = canvas.getContext('2d', {
                    willReadFrequently: true
                });

                // Debug toggle
                debugToggle.addEventListener('click', () => {
                    debugMode = !debugMode;
                    debugToggle.textContent = `DEBUG: ${debugMode ? 'ON' : 'OFF'}`;
                    debugToggle.style.background = debugMode ? 'rgba(0,255,0,0.3)' : 'rgba(0,0,0,0.7)';
                    cardDetector.setDebugMode(debugMode);
                    addDebug(`Debug visualization ${debugMode ? 'enabled' : 'disabled'}`, 'info');
                });

                // Initialize camera
                await camera.initialize(video, canvas);
                addDebug('✓ Camera initialized', 'success');

                // Get guide rectangle bounds (in canvas coordinates)
                function getGuideRegion() {
                    const guideRect = guideEl.getBoundingClientRect();
                    const canvasRect = canvas.getBoundingClientRect();
                    
                    // Convert from screen coordinates to canvas coordinates
                    const scaleX = canvas.width / canvasRect.width;
                    const scaleY = canvas.height / canvasRect.height;
                    
                    return {
                        x: (guideRect.left - canvasRect.left) * scaleX,
                        y: (guideRect.top - canvasRect.top) * scaleY,
                        width: guideRect.width * scaleX,
                        height: guideRect.height * scaleY
                    };
                }

                // Detection loop
                let frameCount = 0;
                let lastFpsUpdate = performance.now();
                let fps = 0;

                const processFrame = async () => {
                    try {
                        frameCount++;
                        
                        // Calculate FPS every second
                        const now = performance.now();
                        if (now - lastFpsUpdate > 1000) {
                            fps = frameCount;
                            frameCount = 0;
                            lastFpsUpdate = now;
                        }

                        // Clear canvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // Draw video frame to get image data
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        // Get guide region
                        const guideRegion = getGuideRegion();
                        
                        // Detect card (only within guide region)
                        const detection = cardDetector.detectCard(imageData, guideRegion);
                        
                        // Draw overlay
                        cardDetector.drawOverlay(ctx, detection);
                        
                        // Update guide visual
                        if (detection && cardDetector.isStable()) {
                            guideEl.classList.add('locked');
                        } else {
                            guideEl.classList.remove('locked');
                        }
                        
                        // Update debug info
                        if (detection) {
                            if (cardDetector.isStable()) {
                                addDebug(
                                    `✓ Card LOCKED | ${fps} FPS | ${cardDetector.getProcessTime().toFixed(1)}ms`, 
                                    'success'
                                );
                            } else {
                                addDebug(
                                    `⚠ Card detected, stabilizing... | ${fps} FPS`, 
                                    'warning'
                                );
                            }
                        } else {
                            // Only update periodically to avoid spam
                            if (frameCount % 30 === 0) {
                                addDebug(
                                    `Scanning for card in guide... | ${fps} FPS | ${cardDetector.getProcessTime().toFixed(1)}ms`,
                                    'info'
                                );
                            }
                        }

                    } catch (error) {
                        addDebug(`Error: ${error.message}`, 'error');
                        console.error('Frame processing error:', error);
                    }
                };

                // Use requestAnimationFrame for smooth loop
                const animate = () => {
                    processFrame();
                    requestAnimationFrame(animate);
                };
                
                addDebug('Starting detection loop...', 'success');
                animate();

            } catch (error) {
                console.error('Initialization error:', error);
                addDebug(`FATAL ERROR: ${error.message}`, 'error');
                
                // Show helpful error message
                if (error.name === 'NotAllowedError' || error.message.includes('permission')) {
                    addDebug('Camera access denied. Please allow camera access in browser settings.', 'error');
                } else if (!window.isSecureContext) {
                    addDebug('Requires HTTPS. Make sure you\'re using https:// URL.', 'error');
                } else {
                    addDebug('Check console for details. Try refreshing the page.', 'error');
                }
            }
        }

        // Start app when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
